<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Salvador ❤ Assunção — App</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --pink:#d6336c;
  --bg1:#fff6f8;
  --bg2:#fff;
  --text:#222;
  --muted:#6b5860;
  --card:#ffffffdd;
  --glass: rgba(255,255,255,0.8);
}
*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
/* Topbar */
.topbar{
  position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;z-index:2000;background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.85));backdrop-filter:blur(6px);border-bottom:1px solid rgba(0,0,0,0.03);
}
.brand{font-weight:800;color:var(--pink);font-size:18px}
.topbar-left{display:flex;align-items:center;gap:12px}
.currentPageName{font-weight:700;color:var(--muted);padding:6px 8px;border-radius:8px;min-width:100px;text-align:center;}
.controls{display:flex;align-items:center;gap:8px}
.hamb-btn{padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}
/* ensure page name never overlapped */
.currentPageName{position:relative;z-index:2100;margin-right:6px}

/* Drawer */
.drawer-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:2500}
.drawer-backdrop.open{display:block}
.drawer{position:fixed;top:0;right:-100%;width:320px;height:100vh;background:#fff;padding:20px;box-shadow:-12px 0 30px rgba(0,0,0,0.15);transition:transform .28s ease,right .28s ease;transform:translateX(100%);z-index:3000}
.drawer.open{right:0;transform:translateX(0)}
.menuitem{padding:12px;border-radius:8px;font-weight:700;cursor:pointer}

/* Layout */
.container{padding:100px 16px 40px;max-width:980px;margin:0 auto}
.card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(255,80,120,0.05);margin-bottom:18px}

/* Login */
#loginCard{max-width:520px;margin:0 auto}
#codeInput{padding:12px;width:100%;border-radius:10px;border:1px solid #eee;margin-top:8px}
.btn{padding:10px 14px;border-radius:10px;border:0;background:var(--pink);color:#fff;font-weight:700;cursor:pointer}
.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
.note{color:var(--muted);font-size:13px;margin-top:8px}

/* Pages */
.page{display:none}
.page.active{display:block}
.bigDate{font-size:28px;font-weight:800;color:var(--pink);text-align:center}
.smallTime{text-align:center;color:var(--muted);margin-top:6px;font-weight:700}

/* Sobre - editor toolbar */
.editor-wrap{display:flex;gap:12px;align-items:flex-start}
.editor-toolbar{width:120px;background:#fff;border:1px solid #f0f0f0;border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:8px}
.editor-toolbar label{font-size:12px;color:var(--muted)}
.editor{flex:1;background:#fff;border-radius:10px;padding:10px;border:1px solid #eee;min-height:140px;overflow:hidden}
.editor [contenteditable]{width:100%;height:100%;outline:none;overflow:auto}
.toolbar-btn{display:inline-block;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;font-size:13px}

/* gallery */
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-top:12px}
.thumb{width:100%;height:110px;object-fit:cover;border-radius:10px}

/* notes */
.notes-header{display:flex;gap:8px;align-items:center}
.notes-list{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.note-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #f2f2f2}

/* calendar */
.calendar-controls{display:flex;justify-content:space-between;align-items:center;gap:8px}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
.calendar-day{padding:10px;border-radius:8px;background:#fff;border:1px solid #eee;text-align:center;cursor:pointer}
.calendar-day.active{background:rgba(214,51,108,0.12)}
.calendar-view-select{padding:8px;border-radius:8px;border:1px solid #eee}

/* clock */
.clock-wrap{display:flex;justify-content:center;align-items:center;gap:18px}
.digital-clock{font-family:Montserrat,Inter,Arial;font-weight:700;font-size:48px;color:var(--pink)}
.analog{width:120px;height:120px;border-radius:50%;background:linear-gradient(180deg,#fff,#fffefc);box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center}
.analog svg{width:88px;height:88px}

/* small separator */
.sep{height:1px;background:linear-gradient(90deg,transparent,#eee,transparent);margin:12px 0}

/* responsive tweaks */
@media(max-width:860px){.editor-wrap{flex-direction:column}.editor-toolbar{width:100%;flex-direction:row;overflow:auto}}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="brand">Salvador ❤ Assunção</div>
    <div id="currentPageName" class="currentPageName" aria-live="polite"></div>
  </div>
  <div class="controls">
    <button id="hamb" class="hamb-btn" title="Menu">☰</button>
  </div>
</div>

<div id="drawerBackdrop" class="drawer-backdrop" aria-hidden="true"></div>
<nav id="drawer" class="drawer" aria-hidden="true">
  <button id="closeDrawer" class="btn ghost" style="float:right">✖</button>
  <h3 style="color:var(--pink);margin-top:6px">Menu</h3>
  <div style="margin-top:12px">
    <div class="menuitem" data-page="home">Página Inicial</div>
    <div class="menuitem" data-page="come">Onde tudo começou</div>
    <div class="menuitem" data-page="sobre">Sobre Nós</div>
    <div class="menuitem" data-page="gal">Galeria</div>
    <div class="menuitem" data-page="notas">Notas</div>
    <div class="menuitem" data-page="cal">Calendário</div>
    <div class="menuitem" data-page="tempo">Tempo</div>
  </div>
  <div class="note" style="margin-top:16px">Privado — apenas com o código secreto</div>
</nav>

<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card" style="max-width:640px;margin:0 auto">
    <h2 style="margin:0;color:var(--pink)">Entrar</h2>
    <p class="note">Coloca aqui o código secreto</p>
    <input id="codeInput" placeholder="escreve o código..." />
    <button id="enterBtn" class="btn" style="margin-top:10px;width:100%">Entrar</button>
    <div id="loginError" style="color:#b00020;margin-top:10px;display:none">Código errado!</div>
    <div class="note">Dica: o código é <strong>sasiboy</strong></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">

    <!-- HOME -->
    <section id="page_home" class="page active">
      <div class="card" style="max-width:720px;margin:0 auto;text-align:center">
        <div class="clock-wrap">
          <div class="analog" aria-hidden="true">
            <!-- simple SVG clock -->
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="48" stroke="#f2f2f2" stroke-width="2" fill="none"></circle>
              <g id="hands">
                <line id="hourHand" x1="50" y1="50" x2="50" y2="30" stroke="#333" stroke-width="3" stroke-linecap="round" transform-origin="50 50"></line>
                <line id="minHand" x1="50" y1="50" x2="50" y2="20" stroke="#333" stroke-width="2" stroke-linecap="round" transform-origin="50 50"></line>
                <line id="secHand" x1="50" y1="50" x2="50" y2="16" stroke="var(--pink)" stroke-width="1" stroke-linecap="round" transform-origin="50 50"></line>
              </g>
              <circle cx="50" cy="50" r="1.6" fill="#333"></circle>
            </svg>
          </div>
          <div>
            <div id="digitalClock" class="digital-clock" aria-live="polite">--:--:--</div>
            <div class="note" style="text-align:center">Relógio em tempo real — bonito e limpo.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ONDE TUDO COMEÇOU -->
    <section id="page_come" class="page">
      <div class="card">
        <h2>Onde tudo começou</h2>
        <p class="note">(Título — escreve mais tarde)</p>
      </div>
    </section>

    <!-- SOBRE NÓS -->
    <section id="page_sobre" class="page">
      <div class="card">
        <h2>Sobre Nós</h2>
        <div style="margin-top:12px">
          <div class="editor-wrap">
            <div class="editor-toolbar" aria-hidden="false">
              <div><label>Fonte</label></div>
              <select id="fontFamily" style="width:100%">
                <option value="Inter">Inter</option>
                <option value="Montserrat">Montserrat</option>
                <option value="serif">Serif</option>
              </select>
              <div><label>Tamanho</label></div>
              <input id="fontSize" type="range" min="12" max="36" value="16" />
              <div><label>Cor</label></div>
              <input id="fontColor" type="color" value="#222222" />

              <div style="margin-top:6px"><label>Alinhamento</label></div>
              <div style="display:flex;gap:6px">
                <button class="toolbar-btn" id="alignLeft">≡</button>
                <button class="toolbar-btn" id="alignCenter">≡</button>
                <button class="toolbar-btn" id="alignRight">≡</button>
              </div>

              <div style="margin-top:8px"><button id="applyStyle" class="btn" style="width:100%">Aplicar</button></div>
            </div>

            <div class="editor">
              <div id="bio_left" class="editableBox" contenteditable="true" aria-label="Bio esquerda" style="font-size:16px;line-height:1.35;overflow:auto">Escreve sobre ti aqui...</div>
            </div>

            <div class="editor">
              <div id="bio_right" class="editableBox" contenteditable="true" aria-label="Bio direita" style="font-size:16px;line-height:1.35;overflow:auto">Escreve sobre ela aqui...</div>
            </div>

          </div>
          <button id="saveBios" class="btn" style="margin-top:12px;width:100%">Guardar</button>
        </div>
      </div>
    </section>

    <!-- GALERIA -->
    <section id="page_gal" class="page">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Galeria</h2>
          <div>
            <button id="addPhotoBtn" class="btn">+</button>
          </div>
        </div>
        <input id="fileInput" type="file" accept="image/*" style="display:none">
        <div id="galleryGrid" class="gallery"></div>
        <div class="note">Adiciona fotos — tira foto no telemóvel ou escolhe da fototeca.</div>
      </div>
    </section>

    <!-- NOTAS -->
    <section id="page_notas" class="page">
      <div class="card">
        <div class="notes-header">
          <h2 style="margin:0">Notas</h2>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <select id="noteFont" style="padding:8px;border-radius:8px;border:1px solid #eee">
              <option value="Inter">Inter</option>
              <option value="Montserrat">Montserrat</option>
            </select>
            <button id="newNote" class="btn ghost">+ Nova</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <div id="noteEditorWrap" style="display:none;gap:8px;flex-direction:column">
            <input id="noteTitle" placeholder="Título" style="padding:8px;border-radius:8px;border:1px solid #eee;width:100%" />
            <div style="display:flex;gap:8px;align-items:center">
              <select id="noteSize" style="padding:8px;border-radius:8px;border:1px solid #eee"><option value="14">14</option><option value="16" selected>16</option><option value="18">18</option></select>
              <input id="noteColor" type="color" value="#222222" />
              <div style="margin-left:auto">
                <button id="saveNote" class="btn">Guardar Nota</button>
              </div>
            </div>
            <div id="noteEditor" contenteditable="true" style="min-height:140px;border-radius:10px;border:1px solid #eee;padding:10px;background:#fff;margin-top:8px;overflow:auto"></div>
          </div>
        </div>

        <div id="notesList" class="notes-list"></div>
      </div>
    </section>

    <!-- CALENDÁRIO -->
    <section id="page_cal" class="page">
      <div class="card">
        <h2>Calendário</h2>

        <div class="calendar-controls">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="calPrev" class="btn ghost">◀</button>
            <div id="calLabel" class="note" style="min-width:160px;text-align:center"></div>
            <button id="calNext" class="btn ghost">▶</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="calView" class="calendar-view-select"><option value="week">Semana</option><option value="month">Mês</option><option value="year">Ano</option><option value="day">Dia</option></select>
          </div>
        </div>

        <div id="calGridWrap">
          <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <textarea id="dayNote" style="width:100%;min-height:100px;border-radius:10px;border:1px solid #eee;margin-top:10px"></textarea>
        <button id="saveDay" class="btn" style="margin-top:10px;width:100%">Guardar Dia</button>
      </div>
    </section>

    <!-- TEMPO -->
    <section id="page_tempo" class="page">
      <div class="card">
        <h2>Tempo</h2>
        <p id="tempoIntro" class="note" style="margin-bottom:12px">
          Estamos juntos desde <strong>17 de setembro de 2025 às 22:00</strong>. Aqui podes ver há quanto tempo estamos juntos — em anos/meses/dias e num temporizador H:M:S.
        </p>

        <div id="ymd" class="bigDate"></div>
        <div id="hms" class="smallTime"></div>
        <div class="sep"></div>
        <div id="tempoSentence" class="note" style="text-align:center;margin-top:6px"></div>
      </div>
    </section>

  </div> <!-- end app -->

</div> <!-- end container -->

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// avoid shadowing the global supabase
const SUPABASE_URL = "https://qtzlyowxjqdsswyxcmzu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0emx5b3d4anFkc3N3eXhjbXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDc1MDUsImV4cCI6MjA4MDE4MzUwNX0.iLb7C7x-qyzY58SHd_n_Fdc2RkVy2hNBkf-n41st02c";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM refs
const loginCard = document.getElementById('loginCard');
const appDiv = document.getElementById('app');
const enterBtn = document.getElementById('enterBtn');
const codeInput = document.getElementById('codeInput');
const loginError = document.getElementById('loginError');
const drawer = document.getElementById('drawer');
const drawerBackdrop = document.getElementById('drawerBackdrop');
const hamb = document.getElementById('hamb');
const closeDrawerBtn = document.getElementById('closeDrawer');

// page helpers
function showPage(p){
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  const el = document.getElementById('page_' + p);
  if(el) el.classList.add('active');
  document.getElementById('currentPageName').textContent = p.charAt(0).toUpperCase() + p.slice(1);
  // small shift so name never hidden by top-right buttons
  document.getElementById('currentPageName').style.paddingRight = '14px';
  if(p==='gal') loadGallery();
  if(p==='notas') loadNotes();
  if(p==='cal') renderCalendar();
  if(p==='tempo') updateTempoUI();
}

// login
enterBtn.addEventListener('click', ()=>{
  const val = (codeInput.value || '').trim();
  if(val.toLowerCase()==='sasiboy'){
    loginError.style.display = 'none';
    loginCard.style.display = 'none';
    appDiv.style.display = 'block';
    showPage('home');
  } else {
    loginError.style.display = 'block';
  }
});

// drawer
function openDrawer(){ drawer.classList.add('open'); drawerBackdrop.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawerBackdrop.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); drawerBackdrop.setAttribute('aria-hidden','true'); }
hamb.addEventListener('click', openDrawer);
closeDrawerBtn.addEventListener('click', closeDrawer);
drawerBackdrop.addEventListener('click', closeDrawer);
document.querySelectorAll('.menuitem').forEach(it=>it.addEventListener('click', ()=>{closeDrawer(); showPage(it.dataset.page);}));

/* =================== CLOCK (HOME) =================== */
function updateHomeClock(){
  const d = new Date();
  document.getElementById('digitalClock').textContent = d.toLocaleTimeString('pt-PT');
  // analog hands
  const sec = d.getSeconds();
  const min = d.getMinutes();
  const hr = d.getHours()%12;
  const secDeg = sec * 6; // 360/60
  const minDeg = min * 6 + sec*0.1; // smooth
  const hrDeg = hr*30 + min*0.5; // smooth
  const secHand = document.getElementById('secHand');
  const minHand = document.getElementById('minHand');
  const hourHand = document.getElementById('hourHand');
  if(secHand) secHand.setAttribute('transform', `rotate(${secDeg} 50 50)`);
  if(minHand) minHand.setAttribute('transform', `rotate(${minDeg} 50 50)`);
  if(hourHand) hourHand.setAttribute('transform', `rotate(${hrDeg} 50 50)`);
}
setInterval(updateHomeClock, 250);
updateHomeClock();

/* =================== ABOUT EDITOR behavior =================== */
// keep editable boxes fixed height; if content overflows, reduce font-size to fit
const editableBoxes = document.querySelectorAll('.editableBox');
function adjustFontToFit(el){
  // start at declared font size and reduce until fits or minimum
  let style = window.getComputedStyle(el);
  let fontSize = parseInt(style.fontSize);
  const min = 12;
  // allow some steps
  function fits(){
    return el.scrollHeight <= el.clientHeight + 6; // small tolerance
  }
  // if smaller content, try increase up to 22
  while(fontSize > min && !fits()){
    fontSize -= 1;
    el.style.fontSize = fontSize + 'px';
  }
}
editableBoxes.forEach(box=>{
  // ensure fixed height
  box.style.maxHeight = '220px';
  box.style.overflow = 'auto';
  box.addEventListener('input', ()=> adjustFontToFit(box));
});

// toolbar controls for Sobre
const fontFamily = document.getElementById('fontFamily');
const fontSize = document.getElementById('fontSize');
const fontColor = document.getElementById('fontColor');
const alignLeft = document.getElementById('alignLeft');
const alignCenter = document.getElementById('alignCenter');
const alignRight = document.getElementById('alignRight');
const applyStyle = document.getElementById('applyStyle');

applyStyle.addEventListener('click', ()=>{
  const ff = fontFamily.value;
  const fs = fontSize.value + 'px';
  const fc = fontColor.value;
  // apply to both boxes
  [document.getElementById('bio_left'), document.getElementById('bio_right')].forEach(el=>{
    el.style.fontFamily = ff;
    el.style.fontSize = fs;
    el.style.color = fc;
    // re-adjust
    adjustFontToFit(el);
  });
});
alignLeft.addEventListener('click', ()=>{ document.querySelectorAll('.editableBox').forEach(e=>e.style.textAlign='left'); });
alignCenter.addEventListener('click', ()=>{ document.querySelectorAll('.editableBox').forEach(e=>e.style.textAlign='center'); });
alignRight.addEventListener('click', ()=>{ document.querySelectorAll('.editableBox').forEach(e=>e.style.textAlign='right'); });

// save bios to supabase as before
document.getElementById('saveBios').addEventListener('click', async ()=>{
  const left = document.getElementById('bio_left').innerText.trim();
  const right = document.getElementById('bio_right').innerText.trim();
  try{
    await supabaseClient.from('notes').insert([{ content: JSON.stringify({ type:'bio', side:'left', text:left }) }, { content: JSON.stringify({ type:'bio', side:'right', text:right }) }]);
    alert('Biografias salvas!');
  }catch(err){console.error(err); alert('Erro ao gravar bios');}
});

/* =================== GALLERY =================== */
const fileInput = document.getElementById('fileInput');
document.getElementById('addPhotoBtn').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const compressed = await compressImg(f, 0.7);
  const name = Date.now() + '_' + f.name.replace(/\s/g,'_');
  try{
    const { data:uploadData, error:uploadErr } = await supabaseClient.storage.from('photos').upload(name, compressed);
    if(uploadErr){ alert('Erro ao enviar: '+uploadErr.message); return; }
    await supabaseClient.from('photos').insert([{ path: uploadData.path }]);
    loadGallery();
  }catch(err){console.error(err); alert('Erro ao enviar foto');}
});
function compressImg(file, quality){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const img = new Image();
      img.onload = ()=>{
        const max = 2000; let w=img.width,h=img.height; if(w>max||h>max){const r=Math.min(max/w,max/h);w=Math.round(w*r);h=Math.round(h*r);} 
        const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        canvas.toBlob(blob=>resolve(blob),'image/jpeg',quality);
      };
      img.onerror = reject; img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}
async function loadGallery(){
  try{
    const { data } = await supabaseClient.from('photos').select('*').order('uploaded_at',{ascending:false});
    const grid = document.getElementById('galleryGrid'); grid.innerHTML='';
    if(!data || data.length===0){ grid.innerHTML = '<div class="note">Galeria vazia.</div>'; return; }
    for(const p of data){ const url = supabaseClient.storage.from('photos').getPublicUrl(p.path).data.publicUrl; const img=document.createElement('img'); img.src=url; img.className='thumb'; grid.appendChild(img); }
  }catch(err){console.error(err);}
}

/* =================== NOTES =================== */
const newNoteBtn = document.getElementById('newNote');
newNoteBtn.addEventListener('click', ()=>{
  document.getElementById('noteEditorWrap').style.display = 'flex';
  document.getElementById('noteEditor').focus();
});

document.getElementById('saveNote').addEventListener('click', async ()=>{
  const title = (document.getElementById('noteTitle').value||'').trim();
  const content = (document.getElementById('noteEditor').innerHTML||'').trim();
  const size = document.getElementById('noteSize').value;
  const color = document.getElementById('noteColor').value;
  if(!content) return alert('Escreve algo primeiro.');
  try{
    await supabaseClient.from('notes').insert([{ title, content, meta: JSON.stringify({ size, color }) }]);
    document.getElementById('noteTitle').value=''; document.getElementById('noteEditor').innerHTML='';
    document.getElementById('noteEditorWrap').style.display='none';
    loadNotes();
  }catch(err){console.error(err); alert('Erro ao gravar nota');}
});

async function loadNotes(){
  try{
    const { data } = await supabaseClient.from('notes').select('*').order('created_at',{ascending:false});
    const list = document.getElementById('notesList'); list.innerHTML='';
    if(!data || data.length===0){ list.innerHTML = '<div class="note">Sem notas ainda</div>'; return; }
    for(const n of data){
      const card = document.createElement('div'); card.className='note-card';
      const meta = n.meta ? JSON.parse(n.meta) : {};
      card.innerHTML = `<div style="font-size:12px;color:var(--muted)">${new Date(n.created_at).toLocaleString()}</div><h3 style="margin:6px 0">${n.title||'Sem título'}</h3><div style="font-size:${meta.size||16}px;color:${meta.color||'#222'}">${n.content}</div>`;
      list.appendChild(card);
    }
  }catch(err){console.error(err);}
}

/* =================== CALENDAR (improved) =================== */
let calDate = new Date();
let calView = 'week';
const calLabel = document.getElementById('calLabel');
const calGrid = document.getElementById('calendarGrid');
const calViewSelect = document.getElementById('calView');
document.getElementById('calPrev').addEventListener('click', ()=>{ navigateCal(-1); });
document.getElementById('calNext').addEventListener('click', ()=>{ navigateCal(1); });
calViewSelect.addEventListener('change', (e)=>{ calView = e.target.value; renderCalendar(); });

function startOfWeek(d){ const nd = new Date(d); const day = nd.getDay(); const diff = nd.getDate() - day + (day===0? -6:1); return new Date(nd.getFullYear(), nd.getMonth(), diff); }

function navigateCal(delta){
  if(calView === 'day') calDate.setDate(calDate.getDate() + delta);
  else if(calView === 'week') calDate.setDate(calDate.getDate() + delta*7);
  else if(calView === 'month') calDate.setMonth(calDate.getMonth() + delta);
  else if(calView === 'year') calDate.setFullYear(calDate.getFullYear() + delta);
  renderCalendar();
}

async function renderCalendar(){
  calGrid.innerHTML='';
  if(calView==='day'){
    const d = new Date(calDate);
    calLabel.textContent = d.toLocaleDateString('pt-PT', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    // show single day big
    const el = document.createElement('div'); el.className='calendar-day'; el.style.gridColumn='1 / -1'; el.style.padding='24px'; el.innerHTML = `<div style="font-weight:800">${d.toLocaleDateString('pt-PT')}</div><div style="margin-top:6px;color:var(--muted)">${d.toLocaleString()}</div>`;
    el.addEventListener('click', ()=> selectDay(d));
    calGrid.appendChild(el);
  } else if(calView==='week'){
    const base = startOfWeek(calDate);
    calLabel.textContent = base.toLocaleDateString('pt-PT', { day:'numeric', month:'long', year:'numeric' }) + ' — semana';
    const days = [];
    for(let i=0;i<7;i++){ days.push(new Date(base.getFullYear(), base.getMonth(), base.getDate()+i)); }
    for(const d of days){ const el=document.createElement('div'); el.className='calendar-day'; el.innerHTML = `<div style="color:var(--muted);font-size:12px">${d.toLocaleDateString('pt-PT',{weekday:'short'})}</div><div style="font-weight:800">${d.getDate()}</div>`; el.addEventListener('click', ()=> selectDay(d)); calGrid.appendChild(el); }
    await markCalEntries(days);
  } else if(calView==='month'){
    const year = calDate.getFullYear(); const month = calDate.getMonth();
    calLabel.textContent = calDate.toLocaleDateString('pt-PT',{month:'long',year:'numeric'});
    const first = new Date(year, month, 1); const last = new Date(year, month+1, 0); const startDay = first.getDay()||7; // monday-start
    // create placeholders
    const totalCells = startDay-1 + last.getDate();
    for(let i=0;i<startDay-1;i++){ const ph=document.createElement('div'); ph.className='calendar-day'; ph.style.background='transparent'; ph.style.border='0'; calGrid.appendChild(ph); }
    const days=[];
    for(let d=1; d<= last.getDate(); d++){ const date=new Date(year,month,d); days.push(date); const el=document.createElement('div'); el.className='calendar-day'; el.innerHTML = `<div style="color:var(--muted);font-size:12px">${date.toLocaleDateString('pt-PT',{weekday:'short'})}</div><div style="font-weight:800">${d}</div>`; el.addEventListener('click', ()=> selectDay(date)); calGrid.appendChild(el); }
    await markCalEntries(days);
  } else if(calView==='year'){
    calLabel.textContent = calDate.getFullYear();
    // show months grid
    const months = Array.from({length:12}, (_,i)=> new Date(calDate.getFullYear(), i, 1));
    for(const m of months){ const el=document.createElement('div'); el.className='calendar-day'; el.innerHTML = `<div style="font-weight:800">${m.toLocaleDateString('pt-PT',{month:'short'})}</div>`; el.addEventListener('click', ()=>{ calDate = new Date(m); calView='month'; calViewSelect.value='month'; renderCalendar(); }); calGrid.appendChild(el); }
  }
}

async function markCalEntries(days){
  try{
    const start = days[0].toISOString().slice(0,10);
    const end = days[days.length-1].toISOString().slice(0,10);
    const { data } = await supabaseClient.from('calendar_entries').select('*').gte('day_date', start).lte('day_date', end);
    const elems = document.querySelectorAll('.calendar-grid .calendar-day');
    // iterate through days and mark
    for(let i=0;i<days.length;i++){
      const dd = days[i].toISOString().slice(0,10);
      if(data && data.find(x=>x.day_date===dd)) elems[i].classList.add('active');
    }
  }catch(err){console.error(err);}
}

let selectedDay = null;
async function selectDay(d){
  selectedDay = d;
  const key = d.toISOString().slice(0,10);
  const { data } = await supabaseClient.from('calendar_entries').select('*').eq('day_date', key).limit(1);
  document.getElementById('dayNote').value = data && data.length ? data[0].text : '';
}

document.getElementById('saveDay').addEventListener('click', async ()=>{
  if(!selectedDay) return alert('Selecciona um dia primeiro.');
  const key = selectedDay.toISOString().slice(0,10);
  const txt = (document.getElementById('dayNote').value||'').trim();
  const { data } = await supabaseClient.from('calendar_entries').select('*').eq('day_date',key).limit(1);
  try{
    if(data && data.length) await supabaseClient.from('calendar_entries').update({ text: txt }).eq('day_date', key);
    else await supabaseClient.from('calendar_entries').insert([{ day_date: key, text: txt }]);
    alert('Guardado!'); renderCalendar();
  }catch(err){console.error(err);alert('Erro ao gravar');}
});

/* =================== TEMPO COUNTER =================== */
const START = new Date("2025-09-17T22:00:00");
function diffYMDHMS(start, now){
  const s = new Date(start.getTime()); const n = new Date(now.getTime());
  let years = n.getFullYear() - s.getFullYear();
  let months = n.getMonth() - s.getMonth();
  let days = n.getDate() - s.getDate();
  if(days < 0){ months--; const prev = new Date(n.getFullYear(), n.getMonth(), 0); days += prev.getDate(); }
  if(months < 0){ years--; months += 12; }
  const totalSeconds = Math.floor((n - s)/1000);
  const hours = Math.floor(totalSeconds/3600) % 24;
  const minutes = Math.floor(totalSeconds/60) % 60;
  const seconds = totalSeconds % 60;
  const totalDays = Math.floor((n - s)/(1000*60*60*24));
  return { years, months, days, hours, minutes, seconds, totalDays };
}
function pad2(n){ return String(n).padStart(2,'0'); }
function plural(n, s){ return `${n} ${s}${n===1? '':'s'}`; }
function buildReadableSentence(d){
  const parts = [];
  if(d.years) parts.push(plural(d.years,'ano'));
  if(d.months) parts.push(plural(d.months,'mês'));
  if(d.days) parts.push(plural(d.days,'dia'));
  const ymd = parts.length ? parts.join(', ') : '0 dias';
  return `Para te lembrares quantos dias passaram desde que tomei a melhor decisão da minha vida... E que possamos voltar aqui e ver que os dias só aumentaram. Amo-te daqui até ao infinito e mais além ❤️\n(${d.totalDays} ${d.totalDays===1?'dia':'dias'})`;
}
function updateTempoUI(){
  const now = new Date(); const d = diffYMDHMS(START, now);
  const parts = [];
  if(d.years) parts.push(`${d.years} ${d.years===1? 'ano':'anos'}`);
  if(d.months) parts.push(`${d.months} ${d.months===1? 'mês':'meses'}`);
  if(d.days) parts.push(`${d.days} ${d.days===1? 'dia':'dias'}`);
  const ymdText = parts.length ? parts.join(' • ') : '0 dias';
  const hmsText = `${pad2(d.hours)}:${pad2(d.minutes)}:${pad2(d.seconds)}`;
  const ymdEl = document.getElementById('ymd'); const hmsEl = document.getElementById('hms'); const sentenceEl = document.getElementById('tempoSentence');
  if(ymdEl) ymdEl.textContent = ymdText;
  if(hmsEl) hmsEl.textContent = `${hmsText} — tempo decorrido (H:M:S)`;
  if(sentenceEl) sentenceEl.textContent = buildReadableSentence(d);
}
setInterval(updateTempoUI, 1000); updateTempoUI();

/* =================== INITIAL STATE =================== */
appDiv.style.display = 'none'; loginCard.style.display = 'block'; document.getElementById('currentPageName').textContent = '';
window.loadGallery = loadGallery; window.loadNotes = loadNotes; window.renderCalendar = renderCalendar; window.updateTempoUI = updateTempoUI;
</script>
</body>
</html>
