<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Salvador ‚ù§ Assun√ß√£o ‚Äî App</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{
  --pink:#d6336c;
  --bg1:#fff6f8;
  --bg2:#fff;
  --text:#222;
  --muted:#6b5860;
  --card:#ffffffdd;
  --glass: rgba(255,255,255,0.8);
}
*{box-sizing:border-box}
html,body{height:100%;}
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
/* Topbar */
.topbar{
  position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:12px 18px;z-index:2000;background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.85));backdrop-filter:blur(6px);border-bottom:1px solid rgba(0,0,0,0.03);
}
.brand{font-weight:800;color:var(--pink);font-size:18px}
.topbar-left{display:flex;align-items:center;gap:12px}
.currentPageName{font-weight:700;color:var(--muted);padding:6px 8px;border-radius:8px;min-width:100px;text-align:center;}
.controls{display:flex;align-items:center;gap:8px}
.hamb-btn{padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}
.currentPageName{position:relative;z-index:2100;margin-right:6px}

/* Drawer */
.drawer-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:2500}
.drawer-backdrop.open{display:block}
.drawer{position:fixed;top:0;right:-100%;width:320px;height:100vh;background:#fff;padding:20px;box-shadow:-12px 0 30px rgba(0,0,0,0.15);transition:transform .28s ease,right .28s ease;transform:translateX(100%);z-index:3000}
.drawer.open{right:0;transform:translateX(0)}
.menuitem{padding:12px;border-radius:8px;font-weight:700;cursor:pointer}

/* Layout */
.container{padding:100px 16px 40px;max-width:980px;margin:0 auto}
.card{background:var(--card);padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(255,80,120,0.05);margin-bottom:18px}

/* Login */
#loginCard{max-width:520px;margin:0 auto}
#codeInput{padding:12px;width:100%;border-radius:10px;border:1px solid #eee;margin-top:8px}
.btn{padding:10px 14px;border-radius:10px;border:0;background:var(--pink);color:#fff;font-weight:700;cursor:pointer}
.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
.note{color:var(--muted);font-size:13px;margin-top:8px}

/* Pages */
.page{display:none}
.page.active{display:block}
.bigDate{font-size:28px;font-weight:800;color:var(--pink);text-align:center}
.smallTime{text-align:center;color:var(--muted);margin-top:6px;font-weight:700}

/* Sobre - editor toolbar */
.editor-wrap{display:flex;gap:12px;align-items:flex-start}
.editor-toolbar{width:120px;background:#fff;border:1px solid #f0f0f0;border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:8px}
.editor-toolbar label{font-size:12px;color:var(--muted)}
.editor{flex:1;background:#fff;border-radius:10px;padding:10px;border:1px solid #eee;min-height:140px;overflow:hidden}
.editor [contenteditable]{width:100%;height:100%;outline:none;overflow:auto}
.toolbar-btn{display:inline-block;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;font-size:13px}

/* gallery */
.gallery-controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-top:12px}
.photo-wrap{position:relative;border-radius:10px;overflow:hidden}
.thumb{width:100%;height:110px;object-fit:cover;display:block}
.photo-delete{position:absolute;top:6px;right:6px;background:rgba(255,255,255,0.9);border-radius:8px;padding:6px;border:1px solid #eee;cursor:pointer;z-index:5}

/* notes */
.notes-header{display:flex;gap:8px;align-items:center}
.notes-list{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.note-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #f2f2f2;display:flex;flex-direction:column;gap:6px}
.note-meta{font-size:12px;color:var(--muted)}
.note-title{font-weight:700}
.note-content{white-space:pre-wrap}
.note-actions{display:flex;gap:8px;justify-content:flex-end}
.edit-btn{padding:6px 8px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
.del-btn{padding:6px 8px;border-radius:8px;border:1px solid #f5c0c5;background:#fff;color:#b00020;cursor:pointer}

/* calendar */
.calendar-controls{display:flex;justify-content:space-between;align-items:center;gap:8px}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
.calendar-day{padding:10px;border-radius:8px;background:#fff;border:1px solid #eee;text-align:center;cursor:pointer}
.calendar-day.active{background:rgba(214,51,108,0.12)}
.calendar-view-select{padding:8px;border-radius:8px;border:1px solid #eee}

/* clock */
.digital-clock{font-family:Montserrat,Inter,Arial;font-weight:700;font-size:48px;color:var(--pink)}
.hms-small{font-weight:700;text-align:center;color:var(--muted);margin-top:6px}

/* small separator */
.sep{height:1px;background:linear-gradient(90deg,transparent,#eee,transparent);margin:12px 0}

/* responsive tweaks */
@media(max-width:860px){.editor-wrap{flex-direction:column}.editor-toolbar{width:100%;flex-direction:row;overflow:auto}}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="brand">Salvador ‚ù§ Assun√ß√£o</div>
    <div id="currentPageName" class="currentPageName" aria-live="polite"></div>
  </div>
  <div class="controls">
    <button id="hamb" class="hamb-btn" title="Menu">‚ò∞</button>
  </div>
</div>

<div id="drawerBackdrop" class="drawer-backdrop" aria-hidden="true"></div>
<nav id="drawer" class="drawer" aria-hidden="true">
  <button id="closeDrawer" class="btn ghost" style="float:right">‚úñ</button>
  <h3 style="color:var(--pink);margin-top:6px">Menu</h3>
  <div style="margin-top:12px">
    <div class="menuitem" data-page="home">P√°gina Inicial</div>
    <div class="menuitem" data-page="come">Onde tudo come√ßou</div>
    <div class="menuitem" data-page="sobre">Sobre N√≥s</div>
    <div class="menuitem" data-page="gal">Galeria</div>
    <div class="menuitem" data-page="notas">Notas</div>
    <div class="menuitem" data-page="cal">Calend√°rio</div>
    <div class="menuitem" data-page="tempo">Tempo</div>
  </div>
  <div class="note" style="margin-top:16px">Privado ‚Äî apenas com o c√≥digo secreto</div>
</nav>

<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card" style="max-width:640px;margin:0 auto">
    <h2 style="margin:0;color:var(--pink)">Entrar</h2>
    <p class="note">Coloca aqui o c√≥digo secreto</p>
    <input id="codeInput" placeholder="escreve o c√≥digo..." />
    <button id="enterBtn" class="btn" style="margin-top:10px;width:100%">Entrar</button>
    <div id="loginError" style="color:#b00020;margin-top:10px;display:none">C√≥digo errado!</div>
    <div class="note">Dica: o c√≥digo √© <strong>sasiboy</strong></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">

    <!-- HOME -->
    <section id="page_home" class="page active">
      <div class="card" style="max-width:720px;margin:0 auto;text-align:center">
        <div>
          <div id="digitalClock" class="digital-clock" aria-live="polite">--:--:--</div>
        </div>
      </div>
    </section>

    <!-- ONDE TUDO COME√áOU -->
    <section id="page_come" class="page">
      <div class="card">
        <h2>Onde tudo come√ßou</h2>
        <p class="note">(T√≠tulo ‚Äî escreve mais tarde)</p>
      </div>
    </section>

    <!-- SOBRE N√ìS -->
    <section id="page_sobre" class="page">
      <div class="card">
        <h2>Sobre N√≥s</h2>
        <div style="margin-top:12px">
          <div class="editor-wrap">
            <div class="editor-toolbar" aria-hidden="false">
              <div><label>Fonte</label></div>
              <select id="fontFamily" style="width:100%">
                <option value="Inter">Inter</option>
                <option value="Montserrat">Montserrat</option>
                <option value="serif">Serif</option>
              </select>
              <div><label>Tamanho</label></div>
              <input id="fontSize" type="range" min="12" max="36" value="16" />
              <div><label>Cor</label></div>
              <input id="fontColor" type="color" value="#222222" />

              <div style="margin-top:6px"><label>Alinhamento</label></div>
              <div style="display:flex;gap:6px">
                <button class="toolbar-btn" id="alignLeft">&lt;</button>
                <button class="toolbar-btn" id="alignCenter">-</button>
                <button class="toolbar-btn" id="alignRight">&gt;</button>
              </div>

            </div>

            <div class="editor">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="font-weight:800">Sass√°</div>
                <div style="visibility:hidden">placeholder</div>
              </div>
              <div id="bio_left" class="editableBox" contenteditable="true" aria-label="Bio esquerda" style="font-size:16px;line-height:1.35;overflow:auto">Escreve sobre ti aqui...</div>
            </div>

            <div class="editor">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="visibility:hidden">placeholder</div>
                <div style="font-weight:800">Assun√ß√£o</div>
              </div>
              <div id="bio_right" class="editableBox" contenteditable="true" aria-label="Bio direita" style="font-size:16px;line-height:1.35;overflow:auto">Escreve sobre ela aqui...</div>
            </div>

          </div>
          <button id="saveBios" class="btn" style="margin-top:12px;width:100%">Guardar</button>
        </div>
      </div>
    </section>

    <!-- GALERIA -->
    <section id="page_gal" class="page">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Galeria</h2>
          <div class="gallery-controls">
            <select id="galleryAlbum" style="padding:8px;border-radius:8px;border:1px solid #eee;background:#fff"></select>
            <button id="newGalleryAlbum" class="btn ghost">+ √Ålbum</button>
            <button id="addPhotoBtn" class="btn">Adicionar</button>
          </div>
        </div>
        <input id="fileInput" type="file" accept="image/*" style="display:none">
        <div id="galleryGrid" class="gallery"></div>
        <div class="note">Adiciona fotos ‚Äî tira foto no telem√≥vel ou escolhe da fototeca.</div>
      </div>
    </section>

    <!-- NOTAS -->
    <section id="page_notas" class="page">
      <div class="card">
        <div class="notes-header">
          <h2 style="margin:0">Notas</h2>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <select id="noteFont" style="padding:8px;border-radius:8px;border:1px solid #eee">
              <option value="Inter">Inter</option>
              <option value="Montserrat">Montserrat</option>
            </select>
            <button id="newNote" class="btn ghost">+ Nova</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <div id="noteEditorWrap" style="display:none;gap:8px;flex-direction:column">
            <input id="noteTitle" placeholder="T√≠tulo" style="padding:8px;border-radius:8px;border:1px solid #eee;width:100%" />
            <div style="display:flex;gap:8px;align-items:center">
              <select id="noteSize" style="padding:8px;border-radius:8px;border:1px solid #eee"><option value="14">14</option><option value="16" selected>16</option><option value="18">18</option></select>
              <input id="noteColor" type="color" value="#222222" />
              <div style="margin-left:auto">
                <button id="saveNote" class="btn">Guardar Nota</button>
              </div>
            </div>
            <div id="noteEditor" contenteditable="true" style="min-height:140px;border-radius:10px;border:1px solid #eee;padding:10px;background:#fff;margin-top:8px;overflow:auto"></div>
          </div>
        </div>

        <div id="notesList" class="notes-list"></div>
      </div>
    </section>

    <!-- CALEND√ÅRIO -->
    <section id="page_cal" class="page">
      <div class="card">
        <h2>Calend√°rio</h2>

        <div class="calendar-controls">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="calPrev" class="btn ghost">‚óÄ</button>
            <div id="calLabel" class="note" style="min-width:160px;text-align:center"></div>
            <button id="calNext" class="btn ghost">‚ñ∂</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="calView" class="calendar-view-select"><option value="week">Semana</option><option value="month">M√™s</option><option value="year">Ano</option><option value="day">Dia</option></select>
          </div>
        </div>

        <div id="calGridWrap">
          <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <textarea id="dayNote" style="width:100%;min-height:100px;border-radius:10px;border:1px solid #eee;margin-top:10px"></textarea>
        <button id="saveDay" class="btn" style="margin-top:10px;width:100%">Guardar Dia</button>
      </div>
    </section>

    <!-- TEMPO -->
    <section id="page_tempo" class="page">
      <div class="card">
        <h2>Tempo</h2>
        <p id="tempoIntro" class="note" style="text-align:center;margin-bottom:12px">
          <small>17 de setembro de 2025 √†s 22:00</small>
        </p>

        <div id="ymd" class="bigDate"></div>
        <div id="hms" class="hms-small"></div>
        <div class="sep"></div>
        <div id="tempoSentence" class="note" style="text-align:center;margin-top:6px"></div>
      </div>
    </section>

  </div> <!-- end app -->

</div> <!-- end container -->

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// Supabase
const SUPABASE_URL = "https://qtzlyowxjqdsswyxcmzu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0emx5b3d4anFkc3N3eXhjbXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDc1MDUsImV4cCI6MjA4MDE4MzUwNX0.iLb7C7x-qyzY58SHd_n_Fdc2RkVy2hNBkf-n41st02c";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== DOM refs ===== */
const loginCard = document.getElementById('loginCard');
const appDiv = document.getElementById('app');
const enterBtn = document.getElementById('enterBtn');
const codeInput = document.getElementById('codeInput');
const loginError = document.getElementById('loginError');

const drawer = document.getElementById('drawer');
const drawerBackdrop = document.getElementById('drawerBackdrop');
const hamb = document.getElementById('hamb');
const closeDrawerBtn = document.getElementById('closeDrawer');

const fileInput = document.getElementById('fileInput');
const addPhotoBtn = document.getElementById('addPhotoBtn');
const galleryGrid = document.getElementById('galleryGrid');
const galleryAlbum = document.getElementById('galleryAlbum');
const newGalleryAlbum = document.getElementById('newGalleryAlbum');

/* ===== Nav & login ===== */
function showPage(p){
  document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
  const el = document.getElementById('page_' + p);
  if(el) el.classList.add('active');
  document.getElementById('currentPageName').textContent = p.charAt(0).toUpperCase() + p.slice(1);
  document.getElementById('currentPageName').style.paddingRight = '14px';
  if(p==='gal') loadGallery();
  if(p==='notas') loadNotes();
  if(p==='cal') renderCalendar();
  if(p==='tempo') updateTempoUI();
}
enterBtn.addEventListener('click', ()=>{
  const val = (codeInput.value || '').trim();
  if(val.toLowerCase()==='sasiboy'){
    loginError.style.display = 'none';
    loginCard.style.display = 'none';
    appDiv.style.display = 'block';
    showPage('home');
    initAfterLogin();
  } else {
    loginError.style.display = 'block';
  }
});
function openDrawer(){ drawer.classList.add('open'); drawerBackdrop.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawerBackdrop.setAttribute('aria-hidden','false'); }
function closeDrawer(){ drawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); drawerBackdrop.setAttribute('aria-hidden','true'); }
hamb.addEventListener('click', openDrawer);
closeDrawerBtn.addEventListener('click', closeDrawer);
drawerBackdrop.addEventListener('click', closeDrawer);
document.querySelectorAll('.menuitem').forEach(it=>it.addEventListener('click', ()=>{closeDrawer(); showPage(it.dataset.page);} ));

/* ===== HOME clock ===== */
function updateHomeClock(){ const d = new Date(); const digital = document.getElementById('digitalClock'); if(digital) digital.textContent = d.toLocaleTimeString('pt-PT'); }
setInterval(updateHomeClock, 1000); updateHomeClock();

/* ===== SOBRE live styles & auto-fit ===== */
const fontFamily = document.getElementById('fontFamily');
const fontSize = document.getElementById('fontSize');
const fontColor = document.getElementById('fontColor');
const alignLeft = document.getElementById('alignLeft');
const alignCenter = document.getElementById('alignCenter');
const alignRight = document.getElementById('alignRight');

function adjustFontToFit(el){
  let style = window.getComputedStyle(el);
  let f = parseInt(style.fontSize) || 16;
  const min = 12;
  function fits(){ return el.scrollHeight <= el.clientHeight + 6; }
  while(f > min && !fits()){ f--; el.style.fontSize = f + 'px'; }
}
function applyLiveStyles(){
  const ff = fontFamily.value;
  const fs = fontSize.value + 'px';
  const fc = fontColor.value;
  [document.getElementById('bio_left'), document.getElementById('bio_right')].forEach(el=>{
    el.style.fontFamily = ff;
    el.style.fontSize = fs;
    el.style.color = fc;
    adjustFontToFit(el);
  });
}
fontFamily.addEventListener('input', applyLiveStyles);
fontSize.addEventListener('input', applyLiveStyles);
fontColor.addEventListener('input', applyLiveStyles);
alignLeft.addEventListener('click', ()=>{ document.querySelectorAll('.editableBox').forEach(e=>e.style.textAlign='left'); });
alignCenter.addEventListener('click', ()=>{ document.querySelectorAll('.editableBox').forEach(e=>e.style.textAlign='center'); });
alignRight.addEventListener('click', ()=>{ document.querySelectorAll('.editableBox').forEach(e=>e.style.textAlign='right'); });

document.querySelectorAll('.editableBox').forEach(b=>{ b.style.maxHeight='220px'; b.style.overflow='auto'; b.addEventListener('input', ()=> adjustFontToFit(b)); b.addEventListener('paste', ()=> setTimeout(()=>adjustFontToFit(b),80)); });

document.getElementById('saveBios').addEventListener('click', async ()=>{
  const left = document.getElementById('bio_left').innerText.trim();
  const right = document.getElementById('bio_right').innerText.trim();
  try{
    await supabaseClient.from('notes').insert([{ content: JSON.stringify({ type:'bio', side:'left', text:left }) }, { content: JSON.stringify({ type:'bio', side:'right', text:right }) }]);
    alert('Biografias salvas!');
  }catch(err){console.error(err); alert('Erro ao gravar bios');}
});

/* ===== GALLERY albums (localStorage) ===== */
function loadGalleryAlbums(){
  const raw = localStorage.getItem('sa_gallery_albums') || '[]';
  let arr = [];
  try{ arr = JSON.parse(raw); }catch(e){ arr = []; }
  // ensure default
  if(!arr.find(a=>a.id==='__all')) arr.unshift({id:'__all', name:'Todos'});
  if(!arr.find(a=>a.id==='__default')) arr.push({id:'__default', name:'Sem √°lbum'});
  // fill select
  galleryAlbum.innerHTML = '';
  arr.forEach(a=>{
    const o = document.createElement('option'); o.value = a.id; o.textContent = a.name; galleryAlbum.appendChild(o);
  });
}
function saveGalleryAlbums(arr){ localStorage.setItem('sa_gallery_albums', JSON.stringify(arr)); }
function createGalleryAlbum(name){
  const raw = localStorage.getItem('sa_gallery_albums') || '[]';
  let arr = [];
  try{ arr = JSON.parse(raw); }catch(e){ arr = []; }
  const id = 'alb_' + Date.now();
  arr.push({id, name});
  saveGalleryAlbums(arr);
  loadGalleryAlbums();
  galleryAlbum.value = id;
  return id;
}
newGalleryAlbum.addEventListener('click', ()=>{
  const n = prompt('Nome do √°lbum:');
  if(n && n.trim()) createGalleryAlbum(n.trim());
});

/* ===== Upload photo (choose album) ===== */
addPhotoBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const album = galleryAlbum.value || '__default';
  try{
    const compressed = await compressImg(f, 0.7);
    const name = Date.now() + '_' + f.name.replace(/\s/g,'_');
    const { data:uploadData, error:uploadErr } = await supabaseClient.storage.from('photos').upload(name, compressed);
    if(uploadErr){ alert('Erro ao enviar: '+uploadErr.message); return; }
    // insert metadata (path + album)
    await supabaseClient.from('photos').insert([{ path: uploadData.path, album: album }]);
    loadGallery();
  }catch(err){console.error(err); alert('Erro ao enviar foto');}
});
function compressImg(file, quality){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const img = new Image();
      img.onload = ()=>{
        const max = 2000; let w=img.width,h=img.height; if(w>max||h>max){const r=Math.min(max/w,max/h);w=Math.round(w*r);h=Math.round(h*r);} 
        const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        canvas.toBlob(blob=>resolve(blob),'image/jpeg',quality);
      };
      img.onerror = reject; img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ===== Load gallery with delete buttons and album filter ===== */
async function loadGallery(){
  loadGalleryAlbums();
  const filter = galleryAlbum.value || '__all';
  try{
    const { data } = await supabaseClient.from('photos').select('*').order('uploaded_at',{ascending:false});
    galleryGrid.innerHTML = '';
    if(!data || data.length===0){ galleryGrid.innerHTML = '<div class="note">Galeria vazia.</div>'; return; }
    for(const p of data){
      const album = p.album || '__default';
      if(filter !== '__all' && filter !== album) continue;
      const url = supabaseClient.storage.from('photos').getPublicUrl(p.path).data.publicUrl;
      const wrap = document.createElement('div'); wrap.className = 'photo-wrap';
      wrap.style.borderRadius = '10px';
      wrap.style.overflow = 'hidden';
      wrap.style.position = 'relative';
      wrap.style.background = '#fff';
      wrap.style.display = 'block';
      const img = document.createElement('img'); img.src = url; img.className = 'thumb';
      const del = document.createElement('button'); del.className = 'photo-delete'; del.innerHTML = 'üóë';
      del.title = 'Apagar foto';
      del.addEventListener('click', async (ev)=>{ ev.stopPropagation(); if(!confirm('Apagar esta foto?')) return; try{ const { error:delErr } = await supabaseClient.storage.from('photos').remove([p.path]); if(delErr) console.warn('Erro apagar storage:',delErr); await supabaseClient.from('photos').delete().eq('id', p.id); loadGallery(); }catch(er){ console.error(er); alert('Erro ao apagar foto'); } });
      wrap.appendChild(img); wrap.appendChild(del);
      galleryGrid.appendChild(wrap);
    }
  }catch(err){console.error(err); galleryGrid.innerHTML = '<div class="note">Erro ao carregar galeria.</div>'; }
}
galleryAlbum.addEventListener('change', loadGallery);

/* ===== NOTES (unchanged behavior + edit/delete kept) ===== */
const newNoteBtn = document.getElementById('newNote');
newNoteBtn.addEventListener('click', ()=>{
  document.getElementById('noteEditorWrap').style.display = 'flex';
  document.getElementById('noteEditor').focus();
});

document.getElementById('saveNote').addEventListener('click', async ()=>{
  const title = (document.getElementById('noteTitle').value||'').trim();
  const content = (document.getElementById('noteEditor').innerHTML||'').trim();
  const size = document.getElementById('noteSize').value;
  const color = document.getElementById('noteColor').value;
  if(!content) return alert('Escreve algo primeiro.');
  try{
    await supabaseClient.from('notes').insert([{ title, content, meta: JSON.stringify({ size, color }) }]);
    document.getElementById('noteTitle').value=''; document.getElementById('noteEditor').innerHTML='';
    document.getElementById('noteEditorWrap').style.display='none';
    loadNotes();
  }catch(err){console.error(err); alert('Erro ao gravar nota');}
});

async function loadNotes(){
  try{
    const { data } = await supabaseClient.from('notes').select('*').order('created_at',{ascending:false});
    const list = document.getElementById('notesList'); list.innerHTML='';
    if(!data || data.length===0){ list.innerHTML = '<div class="note">Sem notas ainda</div>'; return; }
    for(const n of data){
      const card = document.createElement('div'); card.className='note-card'; card.dataset.id = n.id;
      const meta = n.meta ? JSON.parse(n.meta) : {};
      const metaHtml = `<div class="note-meta">${new Date(n.created_at).toLocaleString()}</div>`;
      const titleHtml = `<div class="note-title">${n.title||'Sem t√≠tulo'}</div>`;
      const contentHtml = `<div class="note-content" style="font-size:${meta.size||16}px;color:${meta.color||'#222'}">${n.content}</div>`;
      const actions = document.createElement('div'); actions.className='note-actions';
      const editBtn = document.createElement('button'); editBtn.className='edit-btn'; editBtn.textContent='Editar';
      const delBtn = document.createElement('button'); delBtn.className='del-btn'; delBtn.textContent='Apagar';
      editBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); openInlineEditor(card, n); });
      delBtn.addEventListener('click', async (ev)=>{ ev.stopPropagation(); if(!confirm('Apagar esta nota?')) return; try{ await supabaseClient.from('notes').delete().eq('id', n.id); card.remove(); }catch(e){ console.error(e); alert('Erro ao apagar'); } });
      actions.appendChild(editBtn); actions.appendChild(delBtn);
      card.innerHTML = metaHtml + titleHtml + contentHtml;
      card.appendChild(actions);
      list.appendChild(card);
    }
  }catch(err){console.error(err);}
}

// inline editor for a note (replaces card with editor)
function openInlineEditor(card, note){
  const meta = note.meta ? JSON.parse(note.meta) : {};
  card.innerHTML = '';
  const metaDiv = document.createElement('div'); metaDiv.className = 'note-meta'; metaDiv.textContent = new Date(note.created_at).toLocaleString();
  const titleInput = document.createElement('input'); titleInput.style.width='100%'; titleInput.style.padding='8px'; titleInput.style.border='1px solid #eee'; titleInput.style.borderRadius='8px'; titleInput.value = note.title || '';
  const editorDiv = document.createElement('div'); editorDiv.contentEditable = 'true'; editorDiv.style.minHeight = '120px'; editorDiv.style.border = '1px solid #eee'; editorDiv.style.padding = '8px'; editorDiv.style.borderRadius = '8px'; editorDiv.innerHTML = note.content || '';
  const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px'; controls.style.marginTop='8px'; controls.style.justifyContent='flex-end';
  const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Guardar';
  const cancelBtn = document.createElement('button'); cancelBtn.className='btn ghost'; cancelBtn.textContent='Cancelar';
  const deleteBtn = document.createElement('button'); deleteBtn.className='del-btn'; deleteBtn.textContent='Apagar';
  controls.appendChild(deleteBtn); controls.appendChild(cancelBtn); controls.appendChild(saveBtn);
  card.appendChild(metaDiv); card.appendChild(titleInput); card.appendChild(editorDiv); card.appendChild(controls);

  cancelBtn.addEventListener('click', ()=> loadNotes());
  deleteBtn.addEventListener('click', async ()=>{ if(!confirm('Apagar esta nota?')) return; try{ await supabaseClient.from('notes').delete().eq('id', note.id); loadNotes(); }catch(e){ console.error(e); alert('Erro ao apagar'); } });
  saveBtn.addEventListener('click', async ()=>{ const newTitle = titleInput.value.trim(); const newContent = editorDiv.innerHTML.trim(); try{ await supabaseClient.from('notes').update({ title: newTitle, content: newContent, meta: JSON.stringify({ size: meta.size||16, color: meta.color||'#222' }) }).eq('id', note.id); loadNotes(); }catch(e){ console.error(e); alert('Erro ao guardar'); } });
}

/* ===== CALENDAR (same as before) ===== */
let calDate = new Date();
let calView = 'week';
const calViewSelect = document.getElementById('calView');
const calLabel = document.getElementById('calLabel');
const calendarGrid = document.getElementById('calendarGrid');
document.getElementById('calPrev').addEventListener('click', ()=> navCal(-1));
document.getElementById('calNext').addEventListener('click', ()=> navCal(1));
calViewSelect.addEventListener('change', (e)=>{ calView = e.target.value; renderCalendar(); });

function navCal(delta){ if(calView === 'day') calDate.setDate(calDate.getDate() + delta); else if(calView === 'week') calDate.setDate(calDate.getDate() + delta*7); else if(calView === 'month') calDate.setMonth(calDate.getMonth() + delta); else if(calView === 'year') calDate.setFullYear(calDate.getFullYear() + delta); renderCalendar(); }
function startOfWeek(d){ const n = new Date(d); const day = n.getDay(); const diff = n.getDate() - day + (day===0? -6:1); return new Date(n.getFullYear(), n.getMonth(), diff); }

async function renderCalendar(){
  calendarGrid.innerHTML = '';
  if(calView === 'day'){
    const d = new Date(calDate);
    calLabel.textContent = d.toLocaleDateString('pt-PT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    const el = document.createElement('div'); el.className='calendar-day'; el.style.gridColumn='1 / -1'; el.style.padding='25px';
    el.innerHTML = `<div style="font-weight:800">${d.toLocaleDateString('pt-PT')}</div><div style="margin-top:6px;color:var(--muted)">${d.toLocaleString()}</div>`;
    el.onclick = ()=> selectCalDay(d);
    calendarGrid.appendChild(el); return;
  }
  if(calView === 'week'){
    const start = startOfWeek(calDate);
    calLabel.textContent = `Semana de ${start.toLocaleDateString('pt-PT')}`;
    const days=[]; for(let i=0;i<7;i++){ const dd=new Date(start); dd.setDate(start.getDate()+i); days.push(dd); }
    for(const d of days){ const el=document.createElement('div'); el.className='calendar-day'; el.innerHTML = `<div style="color:var(--muted);font-size:13px">${d.toLocaleDateString('pt-PT',{weekday:'short'})}</div><div style="font-weight:700;font-size:18px">${d.getDate()}</div>`; el.onclick = ()=> selectCalDay(d); calendarGrid.appendChild(el); }
    markEntries(days); return;
  }
  if(calView === 'month'){
    const y = calDate.getFullYear(), m = calDate.getMonth();
    calLabel.textContent = calDate.toLocaleDateString('pt-PT',{month:'long',year:'numeric'});
    const first = new Date(y,m,1), last = new Date(y,m+1,0);
    const startDay = (first.getDay()||7)-1;
    for(let i=0;i<startDay;i++){ const ph=document.createElement('div'); ph.style.opacity='0'; calendarGrid.appendChild(ph); }
    const days=[]; for(let d=1; d<=last.getDate(); d++){ const dt = new Date(y,m,d); days.push(dt); const el=document.createElement('div'); el.className='calendar-day'; el.innerHTML = `<div class="small-note">${dt.toLocaleDateString('pt-PT',{weekday:'short'})}</div><div style="font-weight:800">${d}</div>`; el.onclick = ()=> selectCalDay(dt); calendarGrid.appendChild(el); }
    markEntries(days); return;
  }
  if(calView === 'year'){
    calLabel.textContent = calDate.getFullYear();
    for(let i=0;i<12;i++){ const d=new Date(calDate.getFullYear(), i, 1); const el=document.createElement('div'); el.className='calendar-day'; el.innerHTML = `<div style="font-weight:700">${d.toLocaleDateString('pt-PT',{month:'short'})}</div>`; el.onclick = ()=> { calDate = new Date(d); calView='month'; calViewSelect.value='month'; renderCalendar(); }; calendarGrid.appendChild(el); }
  }
}
async function markEntries(days){
  try{
    const start = days[0].toISOString().slice(0,10), end = days[days.length-1].toISOString().slice(0,10);
    const { data } = await supabaseClient.from('calendar_entries').select('*').gte('day_date', start).lte('day_date', end);
    const cells = Array.from(document.querySelectorAll('.calendar-day')).filter(x=> x.style.opacity !== '0');
    days.forEach((d,i)=>{ const key = d.toISOString().slice(0,10); if(data && data.find(x=>x.day_date===key)) cells[i].classList.add('active'); });
  }catch(e){ console.error(e); }
}
let selectedCalDay = null;
async function selectCalDay(d){ selectedCalDay = d; const key = d.toISOString().slice(0,10); const { data } = await supabaseClient.from('calendar_entries').select('*').eq('day_date', key).limit(1); document.getElementById('dayNote').value = data?.[0]?.text || ''; }
document.getElementById('saveDay').addEventListener('click', async ()=>{ if(!selectedCalDay) return alert('Seleciona um dia primeiro.'); const key = selectedCalDay.toISOString().slice(0,10); const txt = document.getElementById('dayNote').value.trim(); const { data } = await supabaseClient.from('calendar_entries').select('*').eq('day_date', key).limit(1); try{ if(data && data.length) await supabaseClient.from('calendar_entries').update({ text: txt }).eq('day_date', key); else await supabaseClient.from('calendar_entries').insert([{ day_date: key, text: txt }]); alert('Guardado!'); renderCalendar(); }catch(e){ console.error(e); alert('Erro ao gravar'); } });

/* ===== TEMPO (show H:M:S, remove totalDays parenthesis in sentence) ===== */
const START = new Date("2025-09-17T22:00:00");
function pad2(n){ return String(n).padStart(2,'0'); }
function diffYMDHMS(start, now){
  const s = new Date(start.getTime()); const n = new Date(now.getTime());
  let years = n.getFullYear() - s.getFullYear();
  let months = n.getMonth() - s.getMonth();
  let days = n.getDate() - s.getDate();
  if(days < 0){ months--; const prev = new Date(n.getFullYear(), n.getMonth(), 0); days += prev.getDate(); }
  if(months < 0){ years--; months += 12; }
  const totalSeconds = Math.floor((n - s)/1000);
  const hours = Math.floor(totalSeconds/3600) % 24;
  const minutes = Math.floor(totalSeconds/60) % 60;
  const seconds = totalSeconds % 60;
  const totalDays = Math.floor((n - s)/(1000*60*60*24));
  return { years, months, days, hours, minutes, seconds, totalDays };
}
function buildReadableSentenceNoTotal(d){
  const parts = [];
  if(d.years) parts.push(`${d.years} ${d.years===1? 'ano':'anos'}`);
  if(d.months) parts.push(`${d.months} ${d.months===1? 'm√™s':'meses'}`);
  if(d.days) parts.push(`${d.days} ${d.days===1? 'dia':'dias'}`);
  const ymd = parts.length ? parts.join(', ') : '0 dias';
  return `Para te lembrares quantos dias passaram desde que tomei a melhor decis√£o da minha vida... E que possamos voltar aqui e ver que os dias s√≥ aumentaram. Amo-te daqui at√© ao infinito e mais al√©m ‚ù§Ô∏è`;
}
function updateTempoUI(){
  const now = new Date(); const d = diffYMDHMS(START, now);
  const parts = [];
  if(d.years) parts.push(`${d.years} ${d.years===1? 'ano':'anos'}`);
  if(d.months) parts.push(`${d.months} ${d.months===1? 'm√™s':'meses'}`);
  if(d.days) parts.push(`${d.days} ${d.days===1? 'dia':'dias'}`);
  const ymdText = parts.length ? parts.join(' ‚Ä¢ ') : '0 dias';
  const hmsText = `${pad2(d.hours)}:${pad2(d.minutes)}:${pad2(d.seconds)}`;
  const ymdEl = document.getElementById('ymd'); const hmsEl = document.getElementById('hms'); const sentenceEl = document.getElementById('tempoSentence');
  if(ymdEl) ymdEl.textContent = ymdText;
  if(hmsEl) hmsEl.textContent = hmsText;
  if(sentenceEl) sentenceEl.textContent = buildReadableSentenceNoTotal(d);
}
setInterval(updateTempoUI, 1000); updateTempoUI();

/* ===== init after login ===== */
function initAfterLogin(){
  loadGalleryAlbums();
  loadGallery();
  loadNotes();
  renderCalendar();
  applyLiveStyles();
}

/* ===== expose for debugging ===== */
window.loadGallery = loadGallery;
window.loadNotes = loadNotes;
window.renderCalendar = renderCalendar;
</script>
</body>
</html>
