<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Salvador ❤ Assunção</title>
<style>
:root{
  --pink:#d6336c;
  --bg1:#ffe6ef;
  --bg2:#fff9fc;
  --text:#2b2b2b;
  --muted:#704655;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
  min-height:100vh;
}

/* Topbar */
.topbar{
  position:fixed;
  top:0;left:0;right:0;
  height:64px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 18px;
  backdrop-filter:blur(6px);
  background:#ffffffdd;
  z-index:2000;
}
.brand{
  font-weight:800;
  color:var(--pink);
  font-size:18px;
}
.controls{display:flex;align-items:center;gap:8px}

/* Drawer / menu */
.drawer-backdrop{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.25);
  z-index:2500;
}
.drawer-backdrop.open{display:block}
.drawer{
  position:fixed;
  top:0;
  right:-100%;
  width:320px;
  max-width:100%;
  height:100vh;
  background:#fff;
  box-shadow:-10px 0 30px rgba(0,0,0,0.2);
  padding:20px;
  z-index:3000;
  transition:transform .28s ease, right .28s ease;
  transform:translateX(100%);
}
.drawer.open{ right:0; transform:translateX(0); }

/* make it full-screen on small */
@media(max-width:720px){
  .drawer{ width:100%; max-width:none; }
}

/* layout */
.container{
  padding:100px 16px 40px;
  max-width:760px;
  margin:0 auto;
}
.card{
  background:#ffffffdd;
  padding:20px;
  border-radius:16px;
  box-shadow:0 6px 25px rgba(255,80,120,0.08);
  margin-bottom:20px;
}

/* home date/time */
.bigDate{ font-size:28px; font-weight:800; color:var(--pink); text-align:center; }
.smallTime{ text-align:center; color:var(--muted); margin-top:6px; font-weight:700; }

/* pages */
.page{ display:none }
.page.active{ display:block }

/* about split */
.split{ display:flex; gap:12px; }
.col{ flex:1; background:#fff; padding:12px; border-radius:10px; min-height:140px; border:1px solid #eee; }

/* gallery */
.gallery{ display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px; margin-top:12px; }
.thumb{ width:100%; height:110px; object-fit:cover; border-radius:10px; }

/* notes */
.notes-list{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }

/* calendar */
.week{ display:flex; gap:6px; margin-top:10px; }
.day{ flex:1; padding:10px; border-radius:8px; background:#fff; text-align:center; border:1px solid #eee; cursor:pointer; }
.day.active{ background:rgba(214,51,108,0.12) }

/* small helpers */
.btn{ padding:10px 14px; border-radius:10px; border:0; background:var(--pink); color:#fff; font-weight:700; cursor:pointer; }
.ghost{ background:transparent; border:1px solid rgba(0,0,0,0.06); color:var(--muted); }
.note{ color:var(--muted); font-size:13px; margin-top:8px; }
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="brand">Salvador ❤ Assunção</div>
  <div class="controls">
    <div id="currentPageName" style="font-weight:700;color:var(--muted);"></div>
    <div id="hamb" class="btn ghost" style="padding:8px 12px;border-radius:10px">☰</div>
  </div>
</div>

<!-- Drawer & backdrop -->
<div id="drawerBackdrop" class="drawer-backdrop" aria-hidden="true"></div>
<nav id="drawer" class="drawer" aria-hidden="true">
  <button id="closeDrawer" class="btn ghost" style="float:right">✖</button>
  <h3 style="color:var(--pink);margin-top:6px">Menu</h3>
  <div style="margin-top:12px">
    <div class="menuitem" data-page="home" style="padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Página Inicial</div>
    <div class="menuitem" data-page="come" style="padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Onde tudo começou</div>
    <div class="menuitem" data-page="sobre" style="padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Sobre Nós</div>
    <div class="menuitem" data-page="gal" style="padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Galeria</div>
    <div class="menuitem" data-page="notas" style="padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Notas</div>
    <div class="menuitem" data-page="cal" style="padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Calendário</div>
    <div class="menuitem" data-page="tempo" style="padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Tempo</div>
  </div>
  <div class="note" style="margin-top:16px">Privado — apenas com o código secreto</div>
</nav>

<!-- Main container -->
<div class="container">

  <!-- LOGIN CARD -->
  <div id="loginCard" class="card" style="max-width:520px;margin:0 auto">
    <h2 style="margin:0;color:var(--pink)">Entrar</h2>
    <p style="color:var(--muted);margin-top:6px">Coloca aqui o código secreto</p>
    <input id="codeInput" placeholder="escreve o código..." style="padding:12px;width:100%;border-radius:10px;border:1px solid #eee">
    <button id="enterBtn" class="btn" style="margin-top:10px;width:100%">Entrar</button>
    <div id="loginError" style="color:#b00020;margin-top:10px;display:none">Código errado!</div>
    <div class="note">Dica: o código é <strong>sasiboy</strong></div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">

    <!-- HOME -->
    <section id="page_home" class="page active">
      <div class="card" style="max-width:520px;margin:0 auto">
        <div id="dateNow" class="bigDate">--/--/----</div>
        <div id="timeNow" class="smallTime">--:--</div>
      </div>
    </section>

    <!-- ONDE TUDO COMEÇOU -->
    <section id="page_come" class="page">
      <div class="card">
        <h2>Onde tudo começou</h2>
        <p class="note">(Título — escreve mais tarde)</p>
      </div>
    </section>

    <!-- SOBRE NÓS -->
    <section id="page_sobre" class="page">
      <div class="card">
        <h2>Sobre Nós</h2>
        <div class="split" style="margin-top:12px">
          <div class="col">
            <h3>Sassá</h3>
            <div id="bio_left" contenteditable style="min-height:120px;outline:none">Escreve sobre ti aqui...</div>
          </div>
          <div class="col">
            <h3>Assunção</h3>
            <div id="bio_right" contenteditable style="min-height:120px;outline:none">Escreve sobre ela aqui...</div>
          </div>
        </div>
        <button id="saveBios" class="btn" style="margin-top:12px;width:100%">Guardar</button>
      </div>
    </section>

    <!-- GALERIA -->
    <section id="page_gal" class="page">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 style="margin:0">Galeria</h2>
          <div>
            <button id="addPhotoBtn" class="btn">+</button>
          </div>
        </div>
        <input id="fileInput" type="file" accept="image/*" style="display:none">
        <div id="galleryGrid" class="gallery"></div>
        <div class="note">Adiciona fotos — tira foto no telemóvel ou escolhe da fototeca.</div>
      </div>
    </section>

    <!-- NOTAS -->
    <section id="page_notas" class="page">
      <div class="card">
        <h2>Notas</h2>
        <textarea id="noteInput" placeholder="Escreve algo..." style="width:100%;min-height:100px;border-radius:10px;border:1px solid #eee"></textarea>
        <button id="saveNote" class="btn" style="margin-top:10px;width:100%">Guardar Nota</button>
        <div id="notesList" class="notes-list"></div>
      </div>
    </section>

    <!-- CALENDÁRIO -->
    <section id="page_cal" class="page">
      <div class="card">
        <h2>Calendário</h2>
        <div id="monthLabel" class="note" style="text-align:center"></div>
        <div id="weekGrid" class="week"></div>
        <textarea id="dayNote" style="width:100%;min-height:100px;border-radius:10px;border:1px solid #eee;margin-top:10px"></textarea>
        <button id="saveDay" class="btn" style="margin-top:10px;width:100%">Guardar Dia</button>
      </div>
    </section>

    <!-- TEMPO -->
    <section id="page_tempo" class="page">
      <div class="card">
        <h2>Tempo</h2>
        <div id="ymd" class="bigDate"></div>
        <div id="hms" class="smallTime"></div>
      </div>
    </section>

  </div><!-- end app -->

</div><!-- end container -->

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){

  /* ---------- CONFIG SUPABASE (já com as tuas chaves) ---------- */
  const SUPABASE_URL = "https://qtzlyowxjqdsswyxcmzu.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0emx5b3d4anFkc3N3eXhjbXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MDc1MDUsImV4cCI6MjA4MDE4MzUwNX0.iLb7C7x-qyzY58SHd_n_Fdc2RkVy2hNBkf-n41st02c";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* DOM refs */
  const loginCard = document.getElementById('loginCard');
  const appDiv = document.getElementById('app');
  const enterBtn = document.getElementById('enterBtn');
  const codeInput = document.getElementById('codeInput');
  const loginError = document.getElementById('loginError');
  const drawer = document.getElementById('drawer');
  const drawerBackdrop = document.getElementById('drawerBackdrop');
  const hamb = document.getElementById('hamb');
  const closeDrawerBtn = document.getElementById('closeDrawer');

  /* safe show page */
  function showPage(p){
    document.querySelectorAll('.page').forEach(pg=>pg.classList.remove('active'));
    const el = document.getElementById('page_' + p);
    if(el) el.classList.add('active');
    document.getElementById('currentPageName').textContent = p.charAt(0).toUpperCase() + p.slice(1);
    if(p === 'gal') loadGallery();
    if(p === 'notas') loadNotes();
    if(p === 'cal') renderWeek(0);
  }

  /* login: only code 'sasiboy' */
  enterBtn.addEventListener('click', ()=>{
    const val = (codeInput.value || '').trim();
    if(val.toLowerCase() === 'sasiboy'){
      loginError.style.display = 'none';
      loginCard.style.display = 'none';
      appDiv.style.display = 'block';
      showPage('home');
      // load initial content
      loadGallery();
      loadNotes();
      renderWeek(0);
      updateClock(); updTempo();
    } else {
      loginError.style.display = 'block';
    }
  });

  /* drawer handlers */
  function openDrawer(){ drawer.classList.add('open'); drawerBackdrop.classList.add('open'); drawer.setAttribute('aria-hidden','false'); drawerBackdrop.setAttribute('aria-hidden','false'); }
  function closeDrawer(){ drawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); drawerBackdrop.setAttribute('aria-hidden','true'); }
  hamb.addEventListener('click', openDrawer);
  closeDrawerBtn.addEventListener('click', closeDrawer);
  drawerBackdrop.addEventListener('click', closeDrawer);
  document.querySelectorAll('.menuitem').forEach(it=>{
    it.addEventListener('click', ()=>{
      closeDrawer();
      const page = it.dataset.page;
      showPage(page);
    });
  });

  /* Home clock */
  function pad(n){ return String(n).padStart(2,'0'); }
  function updateClock(){
    const d = new Date();
    document.getElementById('dateNow').textContent = d.toLocaleDateString('pt-PT');
    document.getElementById('timeNow').textContent = d.toLocaleTimeString('pt-PT',{hour:'2-digit',minute:'2-digit'});
  }
  setInterval(updateClock,1000);
  updateClock();

  /* COUNTER (tempo juntos) */
  const START = new Date("2025-09-17T22:00:00");
  function diffYMDHMS(start, now){
    let years = now.getFullYear() - start.getFullYear();
    let months = now.getMonth() - start.getMonth();
    let days = now.getDate() - start.getDate();
    if(days < 0){
      months--;
      const prev = new Date(now.getFullYear(), now.getMonth(), 0);
      days += prev.getDate();
    }
    if(months < 0){
      years--;
      months += 12;
    }
    let sec = Math.floor((now - start)/1000);
    let hours = Math.floor(sec/3600) % 24;
    let minutes = Math.floor(sec/60) % 60;
    let seconds = sec % 60;
    return { years, months, days, hours, minutes, seconds };
  }
  function updateCounter(){
    const now = new Date();
    const d = diffYMDHMS(START, now);
    document.getElementById('ymd').textContent = `${d.years} anos • ${d.months} meses • ${d.days} dias`;
    document.getElementById('hms').textContent = `${d.hours} horas, ${d.minutes} minutos, ${d.seconds} segundos`;
  }
  setInterval(updateCounter, 1000);
  updateCounter();
  function updTempo(){ updateCounter(); }

  /* ---------- GALERIA (compressão + upload to supabase storage/photos) ---------- */
  const fileInput = document.getElementById('fileInput');
  document.getElementById('addPhotoBtn').addEventListener('click', ()=> fileInput.click());

  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    // compress
    const compressed = await compressImg(f, 0.6);
    const name = Date.now() + "_" + f.name.replace(/\s/g,'_');
    try{
      const { data:uploadData, error:uploadErr } = await supabase.storage.from('photos').upload(name, compressed);
      if(uploadErr){
        alert('Erro ao enviar: ' + uploadErr.message);
        return;
      }
      await supabase.from('photos').insert([{ path: uploadData.path }]);
      loadGallery();
    }catch(err){
      console.error(err); alert('Erro ao enviar foto');
    }
  });

  function compressImg(file, quality){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = e=>{
        const img = new Image();
        img.onload = ()=>{
          // limit size to 2000px max to keep files small
          const max = 2000;
          let w = img.width, h = img.height;
          if(w > max || h > max){
            const ratio = Math.min(max/w, max/h);
            w = Math.round(w*ratio); h = Math.round(h*ratio);
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          canvas.toBlob(blob=>{
            resolve(blob);
          }, 'image/jpeg', quality);
        };
        img.onerror = (err)=> reject(err);
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  async function loadGallery(){
    try{
      const { data } = await supabase.from('photos').select('*').order('uploaded_at',{ascending:false});
      const grid = document.getElementById('galleryGrid');
      grid.innerHTML = '';
      if(!data || data.length === 0){
        grid.innerHTML = '<div class="note" style="color:var(--muted)">Galeria vazia.</div>';
        return;
      }
      for(const p of data){
        const url = supabase.storage.from('photos').getPublicUrl(p.path).data.publicUrl;
        const img = document.createElement('img');
        img.src = url; img.className = 'thumb';
        grid.appendChild(img);
      }
    }catch(err){
      console.error(err);
    }
  }

  /* ---------- NOTAS ---------- */
  document.getElementById('saveNote').addEventListener('click', async ()=>{
    const txt = (document.getElementById('noteInput').value || '').trim();
    if(!txt) return alert('Escreve algo primeiro.');
    await supabase.from('notes').insert([{ content: txt }]);
    document.getElementById('noteInput').value = '';
    loadNotes();
  });

  async function loadNotes(){
    try{
      const { data } = await supabase.from('notes').select('*').order('created_at',{ascending:false});
      const list = document.getElementById('notesList');
      list.innerHTML = '';
      if(!data || data.length === 0){
        list.innerHTML = '<div class="note">Sem notas ainda</div>'; return;
      }
      for(const n of data){
        const div = document.createElement('div');
        div.innerHTML = `<div style="font-size:12px;color:var(--muted)">${new Date(n.created_at).toLocaleString()}</div>${n.content}`;
        list.appendChild(div);
      }
    }catch(err){
      console.error(err);
    }
  }

  /* ---------- SOBRE NÓS - salvar como dois registos em notes com type bio ---------- */
  document.getElementById('saveBios').addEventListener('click', async ()=>{
    const left = document.getElementById('bio_left').innerText.trim();
    const right = document.getElementById('bio_right').innerText.trim();
    // save as two entries flagged as bio
    await supabase.from('notes').insert([{ content: JSON.stringify({ type:'bio', side:'left', text:left }) }, { content: JSON.stringify({ type:'bio', side:'right', text:right }) }]);
    alert('Biografias salvas!');
  });

  /* ---------- CALENDÁRIO ---------- */
  let weekOffset = 0;
  function startOfWeek(d){
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.getFullYear(), d.getMonth(), diff);
  }
  async function renderWeek(offset){
    weekOffset = offset;
    const now = new Date();
    const base = startOfWeek(now);
    base.setDate(base.getDate() + offset*7);
    const days = [];
    for(let i=0;i<7;i++){
      days.push(new Date(base.getFullYear(), base.getMonth(), base.getDate()+i));
    }
    document.getElementById('monthLabel').textContent = `${days[0].toLocaleString('pt-PT',{month:'long'})} ${days[0].getFullYear()}`;
    const grid = document.getElementById('weekGrid'); grid.innerHTML='';
    for(let i=0;i<7;i++){
      const d = days[i];
      const el = document.createElement('div'); el.className='day';
      el.innerHTML = `<div style="color:var(--muted);font-size:12px">${['S','T','Q','Q','S','S','D'][d.getDay()]}</div><div style="font-weight:800">${d.getDate()}</div>`;
      el.addEventListener('click', ()=> selectDay(d));
      grid.appendChild(el);
    }
    await markEntries(days);
  }
  async function markEntries(days){
    const start = days[0].toISOString().slice(0,10);
    const end = days[6].toISOString().slice(0,10);
    const { data } = await supabase.from('calendar_entries').select('*').gte('day_date',start).lte('day_date',end);
    const elems = document.getElementById('weekGrid').children;
    for(let i=0;i<elems.length;i++){
      elems[i].classList.remove('active');
      const dd = days[i].toISOString().slice(0,10);
      if(data && data.find(x=>x.day_date === dd)) elems[i].classList.add('active');
    }
  }
  let selectedDay = null;
  async function selectDay(d){
    selectedDay = d;
    const key = d.toISOString().slice(0,10);
    const { data } = await supabase.from('calendar_entries').select('*').eq('day_date',key).limit(1);
    document.getElementById('dayNote').value = data && data.length ? data[0].text : '';
  }
  document.getElementById('saveDay').addEventListener('click', async ()=>{
    if(!selectedDay) return alert('Selecciona um dia primeiro.');
    const key = selectedDay.toISOString().slice(0,10);
    const txt = (document.getElementById('dayNote').value || '').trim();
    const { data } = await supabase.from('calendar_entries').select('*').eq('day_date',key).limit(1);
    if(data && data.length){
      await supabase.from('calendar_entries').update({ text: txt }).eq('day_date', key);
    } else {
      await supabase.from('calendar_entries').insert([{ day_date: key, text: txt }]);
    }
    alert('Guardado!');
    renderWeek(weekOffset);
  });

  /* Try to restore / initial hide */
  appDiv.style.display = 'none';
  loginCard.style.display = 'block';
  // initial page name
  document.getElementById('currentPageName').textContent = '';

  // expose some functions for manual calls (dev)
  window.loadGallery = loadGallery;
  window.loadNotes = loadNotes;
  window.renderWeek = renderWeek;
});
</script>
</body>
</html>
